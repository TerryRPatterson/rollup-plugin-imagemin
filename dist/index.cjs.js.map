{"version":3,"file":"index.cjs.js","sources":["../src/index.js"],"sourcesContent":["// Built-ins\nimport path from \"path\";\nimport fs from \"fs\";\nimport util from \"util\";\nimport crypto from \"crypto\";\n\n// Plugin-specific\nimport { createFilter } from \"@rollup/pluginutils\";\nimport chalk from \"chalk\";\nimport mkpath from \"mkpath\";\nimport imageminVendor from \"imagemin\";\nimport imageminJpegtran from \"imagemin-mozjpeg\";\nimport imageminPngquant from \"imagemin-optipng\";\nimport imageminGifsicle from \"imagemin-gifsicle\";\nimport imageminSvgo from \"imagemin-svgo\";\n\n// Promisified methods\nconst readFile = util.promisify(fs.readFile);\nconst writeFile = util.promisify(fs.writeFile);\nconst mkpathAsync = util.promisify(mkpath);\n\n// Returns a new object each time, so that it can't be modified (while it is exported)\n// It is required to export this value for testing\nexport const getDefaultOptions = () => JSON.parse(JSON.stringify({\n  disable: false,\n  verbose: false,\n  emitFiles: true,\n  hashLength: 16,\n  include: \"**/*.{svg,png,jpg,jpeg,gif}\",\n  exclude: \"\",\n  fileName: \"[name]-[hash][extname]\",\n  publicPath: \"\",\n  preserveTree: false,\n  jpegtran: {\n    progressive: true\n  },\n  pngquant: {\n    speed: 1,\n    strip: true\n  },\n  gifsicle: {\n    optimizationLevel: 3\n  },\n  svgo: {\n    precision: 1,\n    multipass: true\n  },\n  plugins: {}\n}));\n\nconst dropUndefinedKeys = obj => Object.entries(obj).reduce((acc, [key, val]) => {\n  if (typeof val !== \"undefined\") {\n    acc[key] = val;\n  }\n\n  return acc;\n}, {});\n\nexport function imagemin (userOptions = {}) {\n  // Default options\n  const defaultOptions = getDefaultOptions();\n\n  // Remove `undefined` user options\n  userOptions = dropUndefinedKeys(userOptions);\n\n  // Inject default plugin factories\n  const allPluginsFactories = {\n    jpegtran: imageminJpegtran,\n    pngquant: imageminPngquant,\n    gifsicle: imageminGifsicle,\n    svgo: imageminSvgo,\n    ...(userOptions.plugins)\n  };\n\n  // Get pairs to use array functions\n  const allPluginsFactoriesPairs = Object.entries(allPluginsFactories);\n\n  // Merge 1st level options\n  const pluginOptions = {...defaultOptions, ...userOptions};\n\n  // Merge user options with defaults for each plugin\n  allPluginsFactoriesPairs.reduce((pluginOptionsAcc, [pluginName,]) => {\n    // Remove `undefined` plugin user options\n    const pluginUserOpts = dropUndefinedKeys(userOptions[pluginName] || {});\n\n    pluginOptionsAcc[pluginName] = {...(defaultOptions[pluginName]), ...pluginUserOpts};\n\n    return pluginOptionsAcc;\n  }, pluginOptions);\n\n  // Run factories\n  pluginOptions.plugins = allPluginsFactoriesPairs.map(([pluginName, factoryFunction]) => factoryFunction(pluginOptions[pluginName]));\n\n  const filter = createFilter(pluginOptions.include, pluginOptions.exclude);\n  const logPrefix = \"imagemin:\";\n  let assets = {};\n\n  return {\n    name: \"imagemin\",\n    buildStart () {\n      if (pluginOptions.verbose && pluginOptions.disable) {\n        pluginOptions.disable ? console.log(chalk.yellow.bold(`${logPrefix} Skipping image optimizations.`)) : console.log(chalk.green.bold(`${logPrefix} Optimizing images...`));\n      }\n    },\n    load (id) {\n      id = path.resolve(id); // Normalise id to match native representation. Required if used with Vite which uses Unix style paths for id.\n      if (!filter(id)) {\n        return null;\n      }\n\n      return readFile(id).then(buffer => {\n        const extname = path.extname(id);\n        const name = pluginOptions.preserveTree\n          ? typeof pluginOptions.preserveTree === \"string\"\n            ? path.join(path.dirname(id.replace(`${path.resolve(pluginOptions.preserveTree)}${path.sep}`, \"\")), path.basename(id, extname))\n            : path.join(path.dirname(id.replace(`${process.cwd()}${path.sep}`, \"\")), path.basename(id, extname))\n          : path.basename(id, extname);\n        let hash, outputFileName;\n\n        if (!pluginOptions.disable) {\n          return imageminVendor.buffer(buffer, {\n            plugins: pluginOptions.plugins\n          }).then(optimizedBuffer => {\n            hash = crypto.createHash(\"sha1\").update(optimizedBuffer).digest(\"hex\").substr(0, pluginOptions.hashLength);\n            outputFileName = path.join(pluginOptions.fileName.replace(/\\[name\\]/i, name).replace(/\\[hash\\]/i, hash).replace(/\\[extname\\]/i, extname)).replace(/\\\\/g, \"/\");\n            assets[outputFileName] = optimizedBuffer;\n\n            if (pluginOptions.verbose) {\n              const inputSize = buffer.toString().length;\n              const outputSize = optimizedBuffer.toString().length;\n              const smaller = outputSize < inputSize;\n              const difference = Math.round(Math.abs(((outputSize / inputSize) * 100) - 1));\n              console.log(chalk.green.bold(`${logPrefix} Optimized ${outputFileName}: ${smaller ? `~${difference}% smaller ðŸŽ‰` : chalk.red(`~${difference}% bigger ðŸ¤•`)}`));\n            }\n\n            return `export default new URL(\"${pluginOptions.publicPath}${outputFileName}\", import.meta.url).href;`;\n          }).catch(error => {\n            this.error(`${logPrefix} Couldn't optimize image: ${error}`);\n          });\n        } else {\n          hash = crypto.createHash(\"sha1\").update(buffer).digest(\"hex\").substr(0, pluginOptions.hashLength);\n          outputFileName = path.join(pluginOptions.fileName.replace(/\\[name\\]/i, name).replace(/\\[hash\\]/i, hash).replace(/\\[extname\\]/i, extname)).replace(/\\\\/g, \"/\");\n          assets[outputFileName] = buffer;\n\n          return `export default new URL(\"${pluginOptions.publicPath}${outputFileName}\", import.meta.url).href;`;\n        }\n      }).catch(error => {\n        this.error(`${logPrefix} Couldn't read asset from disk: ${error}`);\n      });\n    },\n    generateBundle (rollupOptions) {\n      if (!pluginOptions.emitFiles) {\n        return;\n      }\n\n      const base = rollupOptions.dir || path.dirname(rollupOptions.file);\n\n      return Promise.all(Object.keys(assets).map(name => {\n        const assetBase = path.resolve(path.dirname(path.join(base, name)));\n\n        return mkpathAsync(assetBase).then(() => {\n          return writeFile(path.join(base, name), assets[name]).catch(error => {\n            this.error(`${logPrefix} Couldn't write optimized input buffer for ${name}: ${error}`);\n          });\n        });\n      }));\n    }\n  };\n}\n"],"names":["readFile","util","promisify","fs","writeFile","mkpathAsync","mkpath","getDefaultOptions","JSON","parse","stringify","disable","verbose","emitFiles","hashLength","include","exclude","fileName","publicPath","preserveTree","jpegtran","progressive","pngquant","speed","strip","gifsicle","optimizationLevel","svgo","precision","multipass","plugins","dropUndefinedKeys","obj","Object","entries","reduce","acc","key","val","imagemin","userOptions","defaultOptions","allPluginsFactories","imageminJpegtran","imageminPngquant","imageminGifsicle","imageminSvgo","allPluginsFactoriesPairs","pluginOptions","pluginOptionsAcc","pluginName","pluginUserOpts","map","factoryFunction","filter","createFilter","logPrefix","assets","name","buildStart","console","log","chalk","yellow","bold","green","load","id","path","resolve","then","buffer","extname","join","dirname","replace","sep","basename","process","cwd","hash","outputFileName","imageminVendor","optimizedBuffer","crypto","createHash","update","digest","substr","inputSize","toString","length","outputSize","smaller","difference","Math","round","abs","red","catch","error","generateBundle","rollupOptions","base","dir","file","Promise","all","keys","assetBase"],"mappings":"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"}